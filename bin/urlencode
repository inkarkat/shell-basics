#!/bin/bash
# Source: http://stackoverflow.com/a/10660730/813602

printUsage()
{
    cat <<HELPTEXT
URL-encode TEXT (or text read from stdin via -).
With -f|--filespec, path separators (/) are kept unencoded instead of using %2f.
With -n|--newlines, new lines are kept unencoded instead of using %0a.
HELPTEXT
    printf 'Usage: %q %s\n' "$(basename "$1")" '[-f|--filespec] [-n|--newlines] [--] TEXT|- [-?|-h|--help]'
}

isFilespec=
isNewlines=
while [ $# -ne 0 ]
do
    case "$1" in
	--help|-h|-\?)	shift; printUsage "$0"; exit 0;;
	--filespec|-f)	shift; isFilespec=t;;
	--newlines|-n)	shift; isNewlines=t;;
	--)		shift; break;;
	-)		break;;
	-*)		{ echo "ERROR: Unknown option \"$1\"!"; echo; printUsage "$0"; } >&2; exit 2;;
	*)		break;;
    esac
done
[ $# -ne 1 ] && { printUsage "$0" >&2; exit 2; }

if [ "$1" = '-' ]; then
    string=$(< /dev/stdin)
else
    string=${1?}
fi
readonly strlen=${#string}
encoded=
pos=

for (( pos=0; pos < strlen; pos++ ))
do
    c=${string:$pos:1}
    case "$c" in
	[-_.~a-zA-Z0-9])	o="$c";;
	/)			[ "$isFilespec" ] && o="$c" || printf -v o '%%%02x' "'$c";;
	$'\n')			[ "$isNewlines" ] && o="$c" || printf -v o '%%%02x' "'$c";;
	*)			printf -v o '%%%02x' "'$c";;
    esac
    encoded+="$o"
done
printf '%s\n' "$encoded"
