#!/bin/bash

printUsage()
{
    cat <<HELPTEXT
Print a timestamp / prefix output from stdin with timestamps.
HELPTEXT
printf 'Usage: %q %s\n' "$(basename "$1")" '[--human|--short|--sortable] [--no-millis] [-f|--field-separator SEP] [MESSAGE [...]] [-?|-h|--help]'
printf 'Usage: cat FILE [...] | %q %s\n' "$(basename "$1")" '[...] [-s|--separator SEP] -'
}

dateFormat='+%d-%b-%Y${separator}%T${millis}'
separator=' '
millis='.%N'
unset fieldSeparator
while [ $# -ne 0 ]
do
    case "$1" in
	--help|-h|-\?)	shift; printUsage "$0"; exit 0;;
	--human)	shift; dateFormat='+%d-%b-%Y${fieldSeparator-_}%T';;
	--short)	shift; dateFormat='+%Y%m%d${fieldSeparator--}%H%M%S';;
	--sortable)	shift; dateFormat='+%Y-%m-%d${fieldSeparator-_}%T${millis}';;
	--no-millis)	shift; millis=''; shift;;
	--field-separator|-f)
			shift; fieldSeparator="$1"; shift;;
	--separator|-s)	shift; separator="$1"; shift;;
	-)		break;;
	--)		shift; break;;
	-*)		{ echo "ERROR: Unknown option \"$1\"!"; echo; printUsage "$0"; } >&2; exit 2;;
	*)		break;;
    esac
done
if [ $# -eq 1 ] && [ "$1" = '-' ]; then
    isEOL=t
    while IFS=$'\n' read -r line || { isEOL=; [ -n "$line" ]; }
    do
	printf "%s%s%s${isEOL:+\\n}" "$(eval "date \"$dateFormat\"")" "$separator" "$line"
    done
elif [ $# -gt 0 ]; then
    printf '%s%s%s\n' "$(eval "date \"$dateFormat\"")" "$separator" "$*"
else
    eval "date \"$dateFormat\""
fi
