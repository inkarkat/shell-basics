#!/bin/bash

: ${ECHOTRACE_IFS=' '}
[ "$ECHOTRACE_IFS" = newline ] && ECHOTRACE_IFS=$' \\\n  '

printUsage()
{
    cat <<HELPTEXT
Write arguments (separated by a space or \$ECHOTRACE_IFS) as an execution trace
(i.e. with \$PS4 prepended and indicating the nesting level) to standard error /
ECHOTRACE_TRACEFILE, like "set -x" would do (but without the execution).
With --eval, the evaluation result will be printed instead of the (quoted) eval.
HELPTEXT
    printf 'Usage: [ECHOTRACE_IFS=STRING|newline] [ECHOTRACE_TRACEFILE=FILESPEC|&N] %q %s\n' "$(basename "$1")" '[--eval] [--] [SIMPLECOMMAND ...] [-?|-h|--help]'
}
printer()
{
    PRETTYPRINTQUOTEDARGS_IFS="$ECHOTRACE_IFS" \
	PRETTYPRINTQUOTEDARGS_PREFIX="$tracePrefix" \
	exec prettyPrintQuotedArgs -- "$@" >&3
}

while [ $# -ne 0 ]
do
    case "$1" in
	--help|-h|-\?)	shift; printUsage "$0"; exit 0;;
	--eval)		shift
			if [ "$1" = eval ]; then
			    shift
			    printer()
			    {
				joinBy >&3 --prefix "${tracePrefix}" -- "$ECHOTRACE_IFS" "$@"
			    }
			fi
			;;
	--)		shift; break;;
	-*)		{ echo "ERROR: Unknown option \"$1\"!"; echo; printUsage "$0"; } >&2; exit 2;;
	*)		break;;
    esac
done
[ $# -eq 0 ] && exit

case "$ECHOTRACE_TRACEFILE" in
    '')		exec 3>&2;;
    \&[0-9])	eval "exec 3>$ECHOTRACE_TRACEFILE";;
    ?*)		exec 3>>"$ECHOTRACE_TRACEFILE";;
esac

# Duplicated to ../../verbose/bin/verbose
nestingPrefix=
if [ $SHLVL -gt 3 ]; then
    nesting="${PS4:0:1}"
    printf -v nestingPrefix "%$((SHLVL - 3))s" "$nesting"; printf -v nestingPrefix %s "${nestingPrefix// /$nesting}"
fi
tracePrefix="${nestingPrefix}${PS4:-\$ }"

ECHOTRACE_IFS="${ECHOTRACE_IFS//$'\n'/$'\n'${tracePrefix}}"

printer "$@"
